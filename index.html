<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digipen Academy in Busan Attendance Check</title>
</head>
<body>
    <h1>Location based attendance check</h1>
    <p id="status">Confirming Location...</p>
    <button id="check-in-btn" disabled>I'm here</button>

    <script>
        const targetLat = 35.1666176;  // 위도
        const targetLng = 129.1190272; // 경도
        const allowedRadius = 1000; // 반경 1km

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(checkProximity, showError);
            } else {
                document.getElementById("status").innerText = "This browser doesn't support location-based service";
            }
        }

        function checkProximity(position) {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;
            const distance = calculateDistance(targetLat, targetLng, userLat, userLng);

            if (distance <= allowedRadius) {
                document.getElementById("status").innerText = "You are within the check-in area.";
                document.getElementById("check-in-btn").disabled = false;
            } else {
                document.getElementById("status").innerText = userLat+" "+userLng+"You are outside the check-in area.";
            }
        }
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function showError() {
            document.getElementById("status").innerText = "Failed to retrieve location information.";
        }

        document.getElementById("check-in-btn").addEventListener("click", async function() {
            let userName = prompt("Type your phone number");

            let GAS_URL = "https://script.google.com/macros/s/AKfycbzMZjbAOkJt6seRD5IxAxutNtltHqsUC9CAdcr3xn3Xz8ZsMH7oEt3Oehb5XAhnjtyS6A/exec";

            let PROXY_URL = "https://cors-anywhere.herokuapp.com/";

            fetch(PROXY_URL + GAS_URL,  {
                method: "POST",
                mode: "cors",
                headers: { "Content-Type": "application/json",
                           "X-Requested-With": "XMLHttpRequest" },
                body: JSON.stringify({
                    name: userName
                })
            })
            .then(response => response.text())
            .then(text => {
                    try {
                        let data = JSON.parse(text);
                        if (data.status === "success") {
                            alert("✅ " + data.message);
                        } else {
                            alert("❌ " + data.message);
                        }
                    } catch (error) {
                        console.error("JSON parsing error! server might returned HTML.", text);
                        alert("Server error: Not a JSON form\n\n" + text);
                    }
                })
                .catch(error => {
                    console.error("Check-in failed!", error);
                    alert("An error occurred during check-in!");
                });
            });

        getLocation();
    </script>
</body>
</html>